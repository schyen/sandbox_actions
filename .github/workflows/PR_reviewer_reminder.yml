personalised-emails:
  needs: prepare-matrix
  runs-on: ubuntu-latest
  strategy:
    matrix:
      assignee: ${{ fromJSON(needs.prepare-matrix.outputs.matrix-json) }}
  steps:
    - name: Skip contributors with no assigned PRs
      id: check-prs
      run: |
        data='${{ needs.collect-prs.outputs.assigneeMap }}'
        prs=$(jq --arg assignee "${{ matrix.assignee }}" '.[$assignee] // []' <<< "$data")
        count=$(echo "$prs" | jq 'length')
        echo "pr_count=$count" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Exit if no PRs assigned
      if: ${{ steps.check-prs.outputs.pr_count == '0' }}
      run: |
        echo "No PRs assigned to ${{ matrix.assignee }}, skipping email"
        exit 0

    - name: Build personalised email
      id: build
      run: |
        data='${{ needs.collect-prs.outputs.assigneeMap }}'
        prs=$(jq -c --arg assignee "${{ matrix.assignee }}" '.[$assignee]' <<< "$data")

        {
          echo "body<<EOF"
          echo "ðŸ‘‹ Hello @${{ matrix.assignee }},"
          echo
          echo "Here are the PRs currently assigned to you:"
          echo
          echo "$prs" | jq -c '.[]' | while read row; do
            num=$(jq -r '.number' <<< "$row")
            title=$(jq -r '.title' <<< "$row")
            url=$(jq -r '.url' <<< "$row")
            assigned=$(jq -r '.assignedDate' <<< "$row")
            updated=$(jq -r '.updated' <<< "$row")

            echo "- #$num $title ($url)"
            echo "   â€¢ Assigned: $assigned"
            echo "   â€¢ Last updated: $updated"
            echo
          done
          echo "EOF"
        } >> "$GITHUB_OUTPUT"

    - name: Determine recipient email
      id: email
      run: |
        declare -A emails
        emails=( ["schyen"]="$EMAIL_schyen" )
        recipient=${emails["${{ matrix.assignee }}"]}

        if [ -z "$recipient" ]; then
          echo "No email defined for ${{ matrix.assignee }}, skipping"
          exit 0
        fi

        echo "recipient=$recipient" >> $GITHUB_OUTPUT

    - name: Send personalised email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "Weekly GitHub PRs assigned to you â€“ ${{ github.repository }}"
        to: ${{ steps.email.outputs.recipient }}
        from: "github-actions@${{ github.repository }}"
        body: ${{ steps.build.outputs.body }}
